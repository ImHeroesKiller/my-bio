<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Realtime Dashboard dengan D3.js</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 2rem;
        }
        .chart {
            margin: 50px auto;
        }
        .line {
            fill: none;
            stroke: #69b3a2;
            stroke-width: 3px;
        }
        .tooltip {
            position: absolute;
            background: #333;
            color: #fff;
            padding: 8px;
            border-radius: 4px;
            display: none;
        }
    </style>
</head>
<body>
    <h1>Realtime Bitcoin Price Dashboard</h1>
    <div class="tooltip"></div>
    <svg class="chart" width="800" height="400"></svg>

    <script>
        // Inisialisasi data
        const maxDataPoints = 20;
        let data = [];

        // Setup WebSocket
        const ws = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@trade');
        
        // Konfigurasi SVG
        const svg = d3.select(".chart");
        const margin = { top: 20, right: 30, bottom: 40, left: 50 };
        const width = +svg.attr("width") - margin.left - margin.right;
        const height = +svg.attr("height") - margin.top - margin.bottom;

        // Skala waktu dan harga
        const x = d3.scaleTime()
            .range([margin.left, width - margin.right]);

        const y = d3.scaleLinear()
            .range([height - margin.bottom, margin.top]);

        // Garis
        const line = d3.line()
            .x(d => x(d.time))
            .y(d => y(d.price))
            .curve(d3.curveBasis);

        // Sumbu
        const xAxis = d3.axisBottom(x)
            .ticks(5)
            .tickFormat(d3.timeFormat("%H:%M:%S"));

        const yAxis = d3.axisLeft(y)
            .ticks(5);

        // Render awal
        svg.append("g")
            .attr("class", "x-axis")
            .attr("transform", `translate(0,${height - margin.bottom})`);

        svg.append("g")
            .attr("class", "y-axis")
            .attr("transform", `translate(${margin.left},0)`);

        // Fungsi update grafik
        function updateChart() {
            // Update domain
            x.domain(d3.extent(data, d => d.time));
            y.domain([d3.min(data, d => d.price), d3.max(data, d => d.price)]);

            // Update garis
            svg.selectAll(".line")
                .data([data])
                .join("path")
                .attr("class", "line")
                .attr("d", line)
                .attr("transform", null)
                .transition()
                .duration(500)
                .ease(d3.easeLinear);

            // Update titik data
            const dots = svg.selectAll(".dot")
                .data(data);

            dots.enter()
                .append("circle")
                .attr("class", "dot")
                .attr("r", 5)
                .merge(dots)
                .attr("cx", d => x(d.time))
                .attr("cy", d => y(d.price))
                .on("mouseover", (event, d) => {
                    d3.select(".tooltip")
                        .style("display", "block")
                        .html(`Waktu: ${d3.timeFormat("%H:%M:%S")(d.time)}<br>Harga: $${d.price}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 20) + "px");
                })
                .on("mouseout", () => {
                    d3.select(".tooltip").style("display", "none");
                });

            dots.exit().remove();

            // Update sumbu
            svg.select(".x-axis")
                .transition()
                .duration(500)
                .call(xAxis);

            svg.select(".y-axis")
                .transition()
                .duration(500)
                .call(yAxis);
        }

        // Handler WebSocket
        ws.onmessage = function(event) {
            const message = JSON.parse(event.data);
            
            // Konversi data
            const newData = {
                time: new Date(message.T),
                price: parseFloat(message.p)
            };

            // Tambahkan ke dataset
            data.push(newData);
            
            // Batasi jumlah data
            if (data.length > maxDataPoints) {
                data.shift();
            }

            // Update grafik
            updateChart();
        };

        // Handler error WebSocket
        ws.onerror = function(error) {
            console.log('WebSocket Error:', error);
        };
    </script>
</body>
</html>
